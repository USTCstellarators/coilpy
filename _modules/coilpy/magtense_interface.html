
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>coilpy.magtense_interface &#8212; coilpy 0.3.20 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../index.html">
<p class="title">coilpy</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for coilpy.magtense_interface</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.dipole</span> <span class="kn">import</span> <span class="n">Dipole</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">rotation_angle</span>

<span class="c1"># MagTense repo: https://github.com/cmt-dtu-energy/MagTense</span>


<div class="viewcode-block" id="get_center"><a class="viewcode-back" href="../../api/coilpy.magtense_interface.html#coilpy.magtense_interface.get_center">[docs]</a><span class="k">def</span> <span class="nf">get_center</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get geometry information from 8 vertices of a prism.</span>

<span class="sd">    Args:</span>
<span class="sd">        top (numpy.ndarray): Vertices of the top surface, in shape of (4,3).</span>
<span class="sd">        bot (numpy.ndarray): Vertices of the bottom surface, in shape of (4,3).</span>

<span class="sd">    Returns:</span>
<span class="sd">        center (numpy.ndarray): The center of the prism.</span>
<span class="sd">        rot (numpy.ndarray): The rotation angles around x,y,z-axis of the prism.</span>
<span class="sd">        lwh (numpy.ndarray): The dimension of the prism in length, width, height.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># get three axes</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">bot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">bot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">bot</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">bot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">bot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="c1"># get size</span>
    <span class="n">lwh</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n3</span><span class="p">)]</span>
    <span class="c1"># get rotation angle</span>
    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">])</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">rotation_angle</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># reverse the order</span>
    <span class="k">return</span> <span class="n">center</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">lwh</span></div>


<div class="viewcode-block" id="build_prism"><a class="viewcode-back" href="../../api/coilpy.magtense_interface.html#coilpy.magtense_interface.build_prism">[docs]</a><span class="k">def</span> <span class="nf">build_prism</span><span class="p">(</span><span class="n">lwh</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">mag_angle</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">remanence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a prism in magtense.Tiles.</span>

<span class="sd">    Args:</span>
<span class="sd">        center (array-like): The centers of the prisms.</span>
<span class="sd">        rot (array-like): The rotation angles around x,y,z-axis of the prisms.</span>
<span class="sd">        lwh (array-like): The dimensions of the prism in length, width, height.</span>
<span class="sd">        mag_angle (array-like): Magnetization angle in spherical coordinates.</span>
<span class="sd">        mu (array-like): Permeability in the parallel and perpendicular direction.</span>
<span class="sd">        remanence (float or array-like): Magnetic remanence.</span>

<span class="sd">    Returns:</span>
<span class="sd">        prism (magtense.Titles): Prisms in the type of magtense.Titles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">magtense</span>

    <span class="c1"># make it 2d in case only using 1 magnet</span>
    <span class="n">lwh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">lwh</span><span class="p">)</span>
    <span class="n">nmag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lwh</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lwh</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;The size of lwh is not nmag,3&quot;</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;The size of center is not nmag,3&quot;</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;The size of rot is not nmag,3&quot;</span>
    <span class="n">mag_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">mag_angle</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mag_angle</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;The size of mag_angle is not nmag,2&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;The size of mu is not nmag,2&quot;</span>
    <span class="n">remanence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">remanence</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">remanence</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">nmag</span><span class="p">,),</span> <span class="s2">&quot;The size of remanence is not nmag,&quot;</span>
    <span class="c1"># build prisms</span>
    <span class="n">prism</span> <span class="o">=</span> <span class="n">magtense</span><span class="o">.</span><span class="n">Tiles</span><span class="p">(</span><span class="n">nmag</span><span class="p">)</span>
    <span class="n">prism</span><span class="o">.</span><span class="n">set_tile_type</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmag</span><span class="p">):</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_size_i</span><span class="p">(</span><span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_offset_i</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_rotation_i</span><span class="p">(</span><span class="n">rot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_mu_r_ea_i</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_mu_r_oa_i</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_mag_angle_i</span><span class="p">(</span><span class="n">mag_angle</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_color_i</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nmag</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">prism</span><span class="o">.</span><span class="n">set_remanence_i</span><span class="p">(</span><span class="n">remanence</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prism</span></div>


<div class="viewcode-block" id="blocks2tiles"><a class="viewcode-back" href="../../api/coilpy.magtense_interface.html#coilpy.magtense_interface.blocks2tiles">[docs]</a><span class="k">def</span> <span class="nf">blocks2tiles</span><span class="p">(</span><span class="n">block_file</span><span class="p">,</span> <span class="n">dipole_file</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct magtense.Tiles from PM4STELL blocks file</span>

<span class="sd">    Args:</span>
<span class="sd">        block_file (str): Path and file name to the blocks file (usually contains `_blocks.csv`).</span>
<span class="sd">        dipole_file (str): FAMUS dipole file to assign the magnetic moment.</span>
<span class="sd">        clip (float, optional): The minimum rho value to preserve. Defaults to 0.</span>
<span class="sd">        mu (tuple, optional): Magnetic permeability in the parallel and perpendicular direction. Defaults to (1.05, 1.05).</span>

<span class="sd">    Returns:</span>
<span class="sd">        prism (magtense.Tiles): Prisms in the type of magtense.Titles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">magtense</span>

    <span class="k">assert</span> <span class="n">clip</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;the clip value should be &gt;=0.&quot;</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">block_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># remove space in headers</span>
    <span class="n">blocks</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nmag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="s2">&quot;xb1&quot;</span><span class="p">])</span>
    <span class="c1"># cond = np.full((nmag), True)</span>
    <span class="c1"># parse moment data</span>
    <span class="n">dipoles</span> <span class="o">=</span> <span class="n">Dipole</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dipole_file</span><span class="p">)</span>
    <span class="c1"># dipoles.sp2xyz()</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dipoles</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">clip</span>
    <span class="n">nmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
    <span class="c1"># prepare arrays</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">lwh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">mu</span><span class="p">],</span> <span class="n">nmag</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmag</span><span class="p">)</span>
    <span class="c1"># get dimensions</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xt1&quot;</span><span class="p">,</span> <span class="s2">&quot;yt1&quot;</span><span class="p">,</span> <span class="s2">&quot;zt1&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xt2&quot;</span><span class="p">,</span> <span class="s2">&quot;yt2&quot;</span><span class="p">,</span> <span class="s2">&quot;zt2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xt3&quot;</span><span class="p">,</span> <span class="s2">&quot;yt3&quot;</span><span class="p">,</span> <span class="s2">&quot;zt3&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xt4&quot;</span><span class="p">,</span> <span class="s2">&quot;yt4&quot;</span><span class="p">,</span> <span class="s2">&quot;zt4&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xb1&quot;</span><span class="p">,</span> <span class="s2">&quot;yb1&quot;</span><span class="p">,</span> <span class="s2">&quot;zb1&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xb2&quot;</span><span class="p">,</span> <span class="s2">&quot;yb2&quot;</span><span class="p">,</span> <span class="s2">&quot;zb2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xb3&quot;</span><span class="p">,</span> <span class="s2">&quot;yb3&quot;</span><span class="p">,</span> <span class="s2">&quot;zb3&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;xb4&quot;</span><span class="p">,</span> <span class="s2">&quot;yb4&quot;</span><span class="p">,</span> <span class="s2">&quot;zb4&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="c1"># needs to use array operation</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmag</span><span class="p">):</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t1</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">t3</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">t4</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b1</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">b3</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">b4</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">center</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_center</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
        <span class="n">ang</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dipoles</span><span class="o">.</span><span class="n">mt</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">dipoles</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">Br</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dipoles</span><span class="o">.</span><span class="n">mm</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">build_prism</span><span class="p">(</span><span class="n">lwh</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ang</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">Br</span><span class="p">)</span></div>


<div class="viewcode-block" id="corner2tiles"><a class="viewcode-back" href="../../api/coilpy.magtense_interface.html#coilpy.magtense_interface.corner2tiles">[docs]</a><span class="k">def</span> <span class="nf">corner2tiles</span><span class="p">(</span><span class="n">corner_file</span><span class="p">,</span> <span class="n">dipole_file</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct magtense.Tiles from MUSE corner file</span>

<span class="sd">    Args:</span>
<span class="sd">        corner_file (str): Path and file name to the corner file (usually contains `_corner.csv`).</span>
<span class="sd">        dipole_file (str): FAMUS dipole file to assign the magnetic moment.</span>
<span class="sd">        clip (float, optional): The minimum rho value to preserve. Defaults to 0.</span>
<span class="sd">        mu (tuple, optional): Magnetic permeability in the parallel and perpendicular direction. Defaults to (1.05, 1.05).</span>

<span class="sd">    Returns:</span>
<span class="sd">        prism (magtense.Tiles): Prisms in the type of magtense.Titles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">magtense</span>

    <span class="k">assert</span> <span class="n">clip</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;the clip value should be &gt;=0.&quot;</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">corner_file</span><span class="p">)</span>
    <span class="c1"># remove space in headers</span>
    <span class="n">blocks</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nmag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="s2">&quot;n1x&quot;</span><span class="p">])</span>
    <span class="c1"># cond = np.full((nmag), True)</span>
    <span class="c1"># parse moment data</span>
    <span class="n">dipoles</span> <span class="o">=</span> <span class="n">Dipole</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dipole_file</span><span class="p">)</span>
    <span class="c1"># dipoles.sp2xyz()</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dipoles</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">clip</span>
    <span class="n">nmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
    <span class="c1"># prepare arrays</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">lwh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmag</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">mu</span><span class="p">],</span> <span class="n">nmag</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmag</span><span class="p">)</span>
    <span class="c1"># get dimensions</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;n1x&quot;</span><span class="p">,</span> <span class="s2">&quot;n1y&quot;</span><span class="p">,</span> <span class="s2">&quot;n1z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;n2x&quot;</span><span class="p">,</span> <span class="s2">&quot;n2y&quot;</span><span class="p">,</span> <span class="s2">&quot;n2z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;n3x&quot;</span><span class="p">,</span> <span class="s2">&quot;n3y&quot;</span><span class="p">,</span> <span class="s2">&quot;n3z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;n4x&quot;</span><span class="p">,</span> <span class="s2">&quot;n4y&quot;</span><span class="p">,</span> <span class="s2">&quot;n4z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;s1x&quot;</span><span class="p">,</span> <span class="s2">&quot;s1y&quot;</span><span class="p">,</span> <span class="s2">&quot;s1z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;s2x&quot;</span><span class="p">,</span> <span class="s2">&quot;s2y&quot;</span><span class="p">,</span> <span class="s2">&quot;s2z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;s3x&quot;</span><span class="p">,</span> <span class="s2">&quot;s3y&quot;</span><span class="p">,</span> <span class="s2">&quot;s3z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[[</span><span class="s2">&quot;s4x&quot;</span><span class="p">,</span> <span class="s2">&quot;s4y&quot;</span><span class="p">,</span> <span class="s2">&quot;s4z&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="c1"># needs to use srray operation</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmag</span><span class="p">):</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t1</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">t3</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">t4</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b1</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">b3</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">b4</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">center</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_center</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
        <span class="n">ang</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dipoles</span><span class="o">.</span><span class="n">mt</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">dipoles</span><span class="o">.</span><span class="n">mp</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">Br</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dipoles</span><span class="o">.</span><span class="n">mm</span><span class="p">[</span><span class="n">cond</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lwh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">build_prism</span><span class="p">(</span><span class="n">lwh</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">ang</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">Br</span><span class="p">)</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020, Caoxiang Zhu.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>